name: Release Tagging

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Version & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup .npmrc for GitHub Packages
        run: |
          cat > ~/.npmrc << EOF
          @goorm-dev:registry=https://npm.pkg.github.com/
          //npm.pkg.github.com/:_authToken=${{ secrets.GDS_TOKEN }}
          EOF
          echo "‚úÖ .npmrc ÏÑ§Ï†ï ÏôÑÎ£å (GitHub Packages Ïù∏Ï¶ù)"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Check merge type
        id: check-merge
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)

          if echo "$COMMIT_MSG" | grep -qE "Merge branch '(release|hotfix)/"; then
            echo "is_release_or_hotfix=true" >> $GITHUB_OUTPUT

            if echo "$COMMIT_MSG" | grep -qE "Merge branch 'release/"; then
              echo "merge_type=release" >> $GITHUB_OUTPUT
              echo "üéØ Release Î∏åÎûúÏπò Î≥ëÌï© Í∞êÏßÄÎê®"
            elif echo "$COMMIT_MSG" | grep -qE "Merge branch 'hotfix/"; then
              echo "merge_type=hotfix" >> $GITHUB_OUTPUT
              echo "üö® Hotfix Î∏åÎûúÏπò Î≥ëÌï© Í∞êÏßÄÎê®"
            fi
          else
            echo "is_release_or_hotfix=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Release/Hotfix Î≥ëÌï©Ïù¥ ÏïÑÎãò, Ïä§ÌÇµ"
          fi

      - name: Find branch divergence point
        if: steps.check-merge.outputs.is_release_or_hotfix == 'true'
        id: find-divergence
        run: |
          echo "üîç Develop Î∂ÑÍ∏∞Ï†ê Ï∞æÍ∏∞..."

          # release/hotfix Î∏åÎûúÏπòÍ∞Ä developÏóêÏÑú Î∂ÑÍ∏∞Ìïú ÏãúÏ†ê Ï∞æÍ∏∞
          MERGE_BASE=$(git merge-base develop HEAD~1)

          echo "divergence_point=$MERGE_BASE" >> $GITHUB_OUTPUT
          echo "üìç Î∂ÑÍ∏∞Ï†ê: $MERGE_BASE"

      - name: Analyze additional commits and create changesets
        if: steps.check-merge.outputs.is_release_or_hotfix == 'true'
        id: analyze-commits
        run: |
          echo "üîç Ï∂îÍ∞Ä Ïª§Î∞ã Î∂ÑÏÑù Ï§ë..."

          DIVERGENCE="${{ steps.find-divergence.outputs.divergence_point }}"
          MERGE_TYPE="${{ steps.check-merge.outputs.merge_type }}"

          # Î∂ÑÍ∏∞Ï†ê Ïù¥ÌõÑÏùò Î™®Îì† Ïª§Î∞ã Í∞ÄÏ†∏Ïò§Í∏∞ (Î≥ëÌï© Ïª§Î∞ã Ï†úÏô∏)
          COMMITS=$(git log --no-merges --format="%H|%s" ${DIVERGENCE}..HEAD~1)

          CREATED_CHANGESETS=0

          while IFS='|' read -r COMMIT_SHA COMMIT_MSG; do
            if [ -z "$COMMIT_SHA" ]; then continue; fi

            echo ""
            echo "üìù Ïª§Î∞ã Î∂ÑÏÑù: $COMMIT_MSG"

            # Ïù¥ÎØ∏ changesetÏù¥ ÏûàÎäî Ïª§Î∞ãÏù∏ÏßÄ ÌôïÏù∏
            # changeset Ïª§Î∞ãÏùÄ Ïä§ÌÇµ (chore: auto-generate changeset)
            if echo "$COMMIT_MSG" | grep -qE "chore: auto-generate changeset"; then
              echo "  ‚Ü≥ Changeset ÏÉùÏÑ± Ïª§Î∞ã, Ïä§ÌÇµ"
              continue
            fi

            # Ìï¥Îãπ Ïª§Î∞ãÏóêÏÑú Î≥ÄÍ≤ΩÎêú changeset ÌååÏùºÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            CHANGESET_FILES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_SHA | grep "^\.changeset/.*\.md$" | grep -v "README.md" || true)

            if [ -n "$CHANGESET_FILES" ]; then
              echo "  ‚Ü≥ Changeset ÌååÏùº Ïù¥ÎØ∏ Ï°¥Ïû¨: $CHANGESET_FILES"
              continue
            fi

            # Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÌïÑÏöîÏóÜÎäî Ïª§Î∞ã ÌÉÄÏûÖ Ï≤¥ÌÅ¨
            if echo "$COMMIT_MSG" | grep -qE "^(chore|docs|style|test|ci|build)(\(.+\))?:"; then
              echo "  ‚Ü≥ Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ Î∂àÌïÑÏöîÌïú ÌÉÄÏûÖ, Ïä§ÌÇµ"
              continue
            fi

            # Conventional commits Í∏∞Î∞ò Î≤ÑÏ†Ñ Î≤îÌîÑ ÌÉÄÏûÖ Í≤∞Ï†ï
            BUMP_TYPE=""

            if echo "$COMMIT_MSG" | grep -qE "^.+!:|BREAKING CHANGE"; then
              BUMP_TYPE="major"
              echo "  ‚Ü≥ üì¶ Major Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ (BREAKING CHANGE)"
            elif echo "$COMMIT_MSG" | grep -qE "^feat(\(.+\))?:"; then
              BUMP_TYPE="minor"
              echo "  ‚Ü≥ ‚ú® Minor Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ (feat)"
            elif echo "$COMMIT_MSG" | grep -qE "^fix(\(.+\))?:"; then
              BUMP_TYPE="patch"
              echo "  ‚Ü≥ üêõ Patch Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ (fix)"
            elif echo "$COMMIT_MSG" | grep -qE "^(refactor|perf)(\(.+\))?:"; then
              BUMP_TYPE="patch"
              echo "  ‚Ü≥ ‚ôªÔ∏è Patch Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ (refactor/perf)"
            else
              BUMP_TYPE="patch"
              echo "  ‚Ü≥ ‚ö†Ô∏è Conventional Commits ÎØ∏Ï§ÄÏàò ‚Üí patch"
            fi

            # Î≥ÄÍ≤ΩÎêú Ìå®ÌÇ§ÏßÄ Í∞êÏßÄ
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_SHA)
            PACKAGES=""

            while IFS= read -r pkg; do
              if [ ! -f "$pkg" ]; then continue; fi

              PKG_DIR=$(dirname "$pkg")
              PKG_NAME=$(node -p "require('./$pkg').name" 2>/dev/null || echo "")

              if [ -z "$PKG_NAME" ]; then continue; fi

              if echo "$CHANGED_FILES" | grep -q "^$PKG_DIR/"; then
                PACKAGES="$PACKAGES $PKG_NAME"
                echo "  ‚Ü≥ Ìå®ÌÇ§ÏßÄ Í∞êÏßÄ: $PKG_NAME"
              fi
            done < <(find packages apps -name package.json 2>/dev/null)

            # Ìå®ÌÇ§ÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Ïä§ÌÇµ
            if [ -z "$PACKAGES" ]; then
              echo "  ‚Ü≥ ‚ö†Ô∏è Î≥ÄÍ≤ΩÎêú Ìå®ÌÇ§ÏßÄ ÏóÜÏùå, Ïä§ÌÇµ"
              continue
            fi

            # Changeset ÌååÏùº ÏÉùÏÑ±
            CHANGESET_FILE=".changeset/auto-${MERGE_TYPE}-${COMMIT_SHA:0:7}.md"

            echo "---" > $CHANGESET_FILE
            for pkg in $PACKAGES; do
              echo "\"$pkg\": $BUMP_TYPE" >> $CHANGESET_FILE
            done
            echo "---" >> $CHANGESET_FILE
            echo "" >> $CHANGESET_FILE
            echo "$COMMIT_MSG" >> $CHANGESET_FILE

            echo "  ‚Ü≥ ‚úÖ Changeset ÏÉùÏÑ±: $CHANGESET_FILE"

            CREATED_CHANGESETS=$((CREATED_CHANGESETS + 1))

          done <<< "$COMMITS"

          echo ""
          echo "‚úÖ Ï∂îÍ∞Ä Ïª§Î∞ã Î∂ÑÏÑù ÏôÑÎ£å: ${CREATED_CHANGESETS}Í∞úÏùò changeset ÏÉùÏÑ±"
          echo "created_count=$CREATED_CHANGESETS" >> $GITHUB_OUTPUT

      - name: Run changeset version
        if: steps.check-merge.outputs.is_release_or_hotfix == 'true'
        run: |
          echo "üì¶ Changeset version Ïã§Ìñâ Ï§ë..."

          # ChangesetÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" | wc -l)

          if [ "$CHANGESET_COUNT" -eq 0 ]; then
            echo "‚ÑπÔ∏è Changeset ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§. Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÌÇµ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üìù Î∞úÍ≤¨Îêú changeset: ${CHANGESET_COUNT}Í∞ú"

          # changeset version Ïã§Ìñâ
          pnpm changeset version

          # Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏
          if git diff --quiet; then
            echo "‚ÑπÔ∏è Î≤ÑÏ†Ñ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÏóÜÏùå"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit version updates to main
        if: steps.check-merge.outputs.is_release_or_hotfix == 'true'
        id: commit-version
        run: |
          # Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
          if git diff --quiet; then
            echo "‚ÑπÔ∏è Ïª§Î∞ãÌï† Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÏóÜÏùå"
            echo "committed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üì§ Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ïª§Î∞ã Ï§ë..."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "chore(release): version packages"
          git push origin main

          echo "‚úÖ Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ïª§Î∞ã ÏôÑÎ£å"
          echo "committed=true" >> $GITHUB_OUTPUT

      - name: Create tags and GitHub Releases
        if: steps.check-merge.outputs.is_release_or_hotfix == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MERGE_TYPE="${{ steps.check-merge.outputs.merge_type }}"

          if [ "$MERGE_TYPE" = "hotfix" ]; then
            echo "üì¶ Hotfix ÌÉúÍ∑∏ ÏÉùÏÑ± Ï§ë..."
            TITLE_SUFFIX=" (Hotfix)"
          else
            echo "üì¶ Release ÌÉúÍ∑∏ ÏÉùÏÑ± Ï§ë..."
            TITLE_SUFFIX=""
          fi

          # appsÏùò package.json ÌååÏùºÏùÑ Ï∞æÏïÑÏÑú ÌÉúÍ∑∏ ÏÉùÏÑ± (packages Ï†úÏô∏)
          for pkg_json in apps/*/package.json; do
            if [ ! -f "$pkg_json" ]; then continue; fi

            PKG_NAME=$(node -p "require('./$pkg_json').name" 2>/dev/null || echo "")
            if [ -z "$PKG_NAME" ]; then continue; fi

            PKG_VERSION=$(node -p "require('./$pkg_json').version" 2>/dev/null || echo "")
            if [ -z "$PKG_VERSION" ]; then continue; fi

            TAG_NAME="${PKG_NAME}@${PKG_VERSION}"

            # ÌÉúÍ∑∏Í∞Ä Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
            if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
              echo "üì¶ ÌÉúÍ∑∏ ÏÉùÏÑ±: $TAG_NAME"
              git tag "$TAG_NAME"
              git push origin "$TAG_NAME"

              # Github Release ÏÉùÏÑ±
              CHANGELOG_PATH="${pkg_json%package.json}CHANGELOG.md"
              RELEASE_NOTES=""

              if [ -f "$CHANGELOG_PATH" ]; then
                # Ìï¥Îãπ Î≤ÑÏ†ÑÏùò changelog Ï∂îÏ∂ú (Í∞úÏÑ†Îêú ÌååÏã±)
                RELEASE_NOTES=$(sed -n "/^## $PKG_VERSION\$/,/^## [0-9]/p" "$CHANGELOG_PATH" | sed '1d;$d')

                # dependency ÏóÖÎç∞Ïù¥Ìä∏ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                if echo "$RELEASE_NOTES" | grep -q "Updated dependencies"; then
                  # packagesÏùò Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÎèÑ Ìè¨Ìï®
                  DEPS_SECTION=$(echo "$RELEASE_NOTES" | awk '/Updated dependencies/,0')

                  # Ïã§Ï†ú Ìå®ÌÇ§ÏßÄ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï∂îÍ∞Ä
                  for dep_pkg in packages/*/package.json; do
                    if [ ! -f "$dep_pkg" ]; then continue; fi
                    DEP_NAME=$(node -p "require('./$dep_pkg').name" 2>/dev/null || echo "")
                    DEP_VERSION=$(node -p "require('./$dep_pkg').version" 2>/dev/null || echo "")

                    if echo "$DEPS_SECTION" | grep -q "$DEP_NAME@$DEP_VERSION"; then
                      # Ìï¥Îãπ Ìå®ÌÇ§ÏßÄÏùò CHANGELOGÏóêÏÑú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Í∞ÄÏ†∏Ïò§Í∏∞
                      DEP_CHANGELOG="${dep_pkg%package.json}CHANGELOG.md"
                      if [ -f "$DEP_CHANGELOG" ]; then
                        DEP_CHANGES=$(sed -n "/^## $DEP_VERSION\$/,/^## [0-9]/p" "$DEP_CHANGELOG" | sed '1d;$d' | grep "^- " | head -5)
                        if [ -n "$DEP_CHANGES" ]; then
                          RELEASE_NOTES=$(printf "%s\n\n### Changes in %s@%s\n%s" "$RELEASE_NOTES" "$DEP_NAME" "$DEP_VERSION" "$DEP_CHANGES")
                        fi
                      fi
                    fi
                  done
                fi
              fi

              # Release ÏÉùÏÑ±
              if [ -n "$RELEASE_NOTES" ]; then
                gh release create "$TAG_NAME" \
                  --title "${TAG_NAME}${TITLE_SUFFIX}" \
                  --notes "$RELEASE_NOTES" || echo "‚ö†Ô∏è Release ÏÉùÏÑ± Ïã§Ìå®: $TAG_NAME"
              else
                gh release create "$TAG_NAME" \
                  --title "${TAG_NAME}${TITLE_SUFFIX}" \
                  --notes "Release $TAG_NAME" || echo "‚ö†Ô∏è Release ÏÉùÏÑ± Ïã§Ìå®: $TAG_NAME"
              fi

              echo "‚úÖ ÌÉúÍ∑∏ Î∞è Î¶¥Î¶¨Ï¶à ÏÉùÏÑ± ÏôÑÎ£å: $TAG_NAME"
              echo ""
            else
              echo "‚úÖ ÌÉúÍ∑∏ $TAG_NAME Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï®, Ïä§ÌÇµ"
              echo ""
            fi
          done

          echo "‚úÖ Î™®Îì† Î¶¥Î¶¨Ï¶à Î∞∞Ìè¨ ÏôÑÎ£å"

      - name: Summary
        if: steps.check-merge.outputs.is_release_or_hotfix == 'true'
        run: |
          MERGE_TYPE="${{ steps.check-merge.outputs.merge_type }}"
          CREATED_CHANGESETS="${{ steps.analyze-commits.outputs.created_count }}"

          echo "## üéâ Release ÏûêÎèôÌôî ÏôÑÎ£å" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ÌÉÄÏûÖ:** \`$MERGE_TYPE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CREATED_CHANGESETS" -gt 0 ]; then
            echo "**ÏÉùÏÑ±Îêú Changeset:** ${CREATED_CHANGESETS}Í∞ú" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**ÏàòÌñâÎêú ÏûëÏóÖ:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Ï∂îÍ∞Ä Ïª§Î∞ã Î∂ÑÏÑù Î∞è changeset ÏÉùÏÑ±" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Î≤ÑÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ Î∞è CHANGELOG ÏÉùÏÑ±" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Main Î∏åÎûúÏπòÏóê ÏûêÎèô Ïª§Î∞ã" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Git ÌÉúÍ∑∏ Î∞è GitHub Release ÏÉùÏÑ±" >> $GITHUB_STEP_SUMMARY
