#!/bin/bash
#
# Git Flow Hotfix Hook - Automatic Version Update
#
# This hook runs before 'git flow hotfix finish'
# It automatically generates changeset, runs version update, and commits
#

set -e

BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# hotfix ë¸Œëžœì¹˜ì¸ì§€ í™•ì¸
if [[ ! $BRANCH =~ ^hotfix/ ]]; then
  echo "âš ï¸  Hotfix ë¸Œëžœì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤: $BRANCH"
  exit 0
fi

echo ""
echo "ðŸš¨ Git Flow Hotfix Hook ì‹¤í–‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸
if [ -n "$(git status --porcelain)" ]; then
  echo "âš ï¸  ê²½ê³ : ì»¤ë°‹ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìžˆìŠµë‹ˆë‹¤"
  git status --short
  echo ""
  read -p "ìŠ¤íƒœì‹œí•˜ê³  ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    git stash push -m "pre-hotfix-hook-stash"
    STASHED=true
  else
    echo "âŒ Hotfix ì¤‘ë‹¨"
    exit 1
  fi
fi

# ë³€ê²½ëœ íŒ¨í‚¤ì§€ ê°ì§€
echo "ðŸ” ë³€ê²½ëœ íŒ¨í‚¤ì§€ ê°ì§€ ì¤‘..."
MAIN_BRANCH=$(git config --get gitflow.branch.master || echo "main")
CHANGED_FILES=$(git diff --name-only $MAIN_BRANCH...HEAD)

PACKAGES=""
while IFS= read -r pkg; do
  if [ ! -f "$pkg" ]; then continue; fi

  PKG_DIR=$(dirname "$pkg")
  PKG_NAME=$(node -p "require('./$pkg').name" 2>/dev/null || echo "")
  if [ -z "$PKG_NAME" ]; then continue; fi

  if echo "$CHANGED_FILES" | grep -q "^$PKG_DIR/"; then
    PACKAGES="$PACKAGES $PKG_NAME"
  fi
done < <(find packages apps -name package.json -not -path "./node_modules/*" 2>/dev/null)

PACKAGES=$(echo "$PACKAGES" | xargs)

if [ -z "$PACKAGES" ]; then
  echo "âš ï¸  ê²½ê³ : ë³€ê²½ëœ íŒ¨í‚¤ì§€ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
  echo ""
  read -p "ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Hotfix ì¤‘ë‹¨"
    exit 1
  fi
  if [ "$STASHED" = true ]; then
    git stash pop
  fi
  exit 0
fi

echo "ðŸ“¦ ë³€ê²½ëœ íŒ¨í‚¤ì§€: $PACKAGES"
echo ""

# ì»¤ë°‹ ë©”ì‹œì§€ ë¶„ì„í•˜ì—¬ ë²„ì „ ë²”í”„ íƒ€ìž… ê²°ì •
COMMITS=$(git log --format=%s $MAIN_BRANCH..HEAD)
BUMP_TYPE="patch"

if echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?!?:"; then
  BUMP_TYPE="minor"
  echo "ðŸ“Š ë²„ì „ ë²”í”„: minor (feat ê°ì§€)"
elif echo "$COMMITS" | grep -qiE "^(BREAKING CHANGE|.*!:)"; then
  BUMP_TYPE="major"
  echo "ðŸ“Š ë²„ì „ ë²”í”„: major (BREAKING CHANGE ê°ì§€)"
else
  echo "ðŸ“Š ë²„ì „ ë²”í”„: patch (ê¸°ë³¸)"
fi
echo ""

# Changeset ìƒì„±
echo "ðŸ“ Changeset ìƒì„± ì¤‘..."
CHANGESET_ID=$(date +%s)
CHANGESET_FILE=".changeset/hotfix-${CHANGESET_ID}.md"

cat > $CHANGESET_FILE << EOF
---
EOF

for pkg in $PACKAGES; do
  echo "\"$pkg\": $BUMP_TYPE" >> $CHANGESET_FILE
done

cat >> $CHANGESET_FILE << EOF
---

ðŸš¨ Hotfix: $BRANCH
EOF

echo "âœ… Changeset ìƒì„±: $(basename $CHANGESET_FILE)"
cat $CHANGESET_FILE
echo ""

# Changeset version ì‹¤í–‰
echo "ðŸ”„ ë²„ì „ ì—…ë°ì´íŠ¸ ì‹¤í–‰ ì¤‘..."
if ! pnpm changeset version; then
  echo "âŒ Changeset version ì‹¤íŒ¨"
  rm -f $CHANGESET_FILE
  exit 1
fi
echo "âœ… ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
echo ""

# ë¹Œë“œ ì‹¤í–‰
echo "ðŸ”¨ íŒ¨í‚¤ì§€ ë¹Œë“œ ì¤‘..."
if ! pnpm build; then
  echo "âš ï¸  ë¹Œë“œ ì‹¤íŒ¨ - ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤"
else
  echo "âœ… ë¹Œë“œ ì™„ë£Œ"
fi
echo ""

# ì—…ë°ì´íŠ¸ëœ ë‚´ìš© í‘œì‹œ
echo "ðŸ“ ì—…ë°ì´íŠ¸ëœ íŒŒì¼:"
git status --short
echo ""

# ì»¤ë°‹
echo "ðŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
git add .
git commit -m "chore(hotfix): version packages

ðŸš¨ Hotfix: $BRANCH
ðŸ¤– Auto-generated by git-flow pre-hotfix hook"

echo "âœ… ì»¤ë°‹ ì™„ë£Œ"
echo ""

# Stash ë³µêµ¬
if [ "$STASHED" = true ]; then
  git stash pop
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ Hotfix Hook ì™„ë£Œ - git flow hotfix finish ê³„ì† ì§„í–‰"
echo ""

exit 0
