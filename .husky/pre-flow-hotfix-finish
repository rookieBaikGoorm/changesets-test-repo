#!/bin/bash
#
# Git Flow Hotfix Hook - Automatic Version Update
#
# This hook runs before 'git flow hotfix finish'
# It automatically generates changeset, runs version update, and commits
#

set -e

# 색상 정의
WHITE='\033[37m'
RED='\033[31m'
GREEN='\033[32m'
RESET='\033[0m'

BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# hotfix 브랜치인지 확인
if [[ ! $BRANCH =~ ^hotfix/ ]]; then
  echo "⚠️  Hotfix 브랜치가 아닙니다: $BRANCH"
  exit 0
fi

echo ""
echo -e "${WHITE}Git Flow Hotfix Hook 실행${RESET}"
echo -e "${WHITE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 변경사항이 있는지 확인 (.changeset 파일 제외)
CHANGES=$(git status --porcelain | grep -v "^.. .changeset/" || true)
if [ -n "$CHANGES" ]; then
  echo -e "${WHITE}경고: 커밋되지 않은 변경사항이 있습니다${RESET}"
  echo "$CHANGES" | sed 's/^/  ⎿ /'
  echo ""
  read -p "스태시하고 계속하시겠습니까? (y/N): " -n 1 -r
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    git stash push -m "pre-hotfix-hook-stash"
    STASHED=true
  else
    echo "Hotfix 중단"
    exit 1
  fi
fi

# 변경된 패키지 감지
echo -e "${WHITE}1️⃣ 변경된 패키지 감지 및 Changeset 생성 중...${RESET}"
MAIN_BRANCH=$(git config --get gitflow.branch.master || echo "main")
CHANGED_FILES=$(git diff --name-only $MAIN_BRANCH...HEAD)

PACKAGES=""
while IFS= read -r pkg; do
  if [ ! -f "$pkg" ]; then continue; fi

  PKG_DIR=$(dirname "$pkg")
  PKG_NAME=$(node -p "require('./$pkg').name" 2>/dev/null || echo "")
  if [ -z "$PKG_NAME" ]; then continue; fi

  if echo "$CHANGED_FILES" | grep -q "^$PKG_DIR/"; then
    PACKAGES="$PACKAGES $PKG_NAME"
  fi
done < <(find packages apps -name package.json -not -path "./node_modules/*" 2>/dev/null)

PACKAGES=$(echo "$PACKAGES" | xargs)

if [ -z "$PACKAGES" ]; then
  echo -e "${WHITE}   ⎿ 경고: 변경된 패키지가 감지되지 않았습니다"
  echo ""
  read -p "계속 진행하시겠습니까? (y/N): " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Hotfix 중단"
    exit 1
  fi
  if [ "$STASHED" = true ]; then
    git stash pop
  fi
  exit 0
fi

echo -e "${WHITE}   ⎿ 변경된 패키지: $PACKAGES${RESET}"
echo ""
COMMITS=$(git log --format=%s $MAIN_BRANCH..HEAD)
BUMP_TYPE="patch"

if echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?!?:"; then
  BUMP_TYPE="minor"
  echo -e "${WHITE}   ⎿ 버전 범프: minor (feat 감지)"
elif echo "$COMMITS" | grep -qiE "^(BREAKING CHANGE|.*!:)"; then
  BUMP_TYPE="major"
  echo -e "${WHITE}   ⎿ 버전 범프: major (BREAKING CHANGE 감지)"
else
  echo -e "${WHITE}   ⎿ 버전 범프: patch (기본)"
fi
echo ""
CHANGESET_ID=$(date +%s)
CHANGESET_FILE=".changeset/hotfix-${CHANGESET_ID}.md"

cat > $CHANGESET_FILE << EOF
---
EOF

for pkg in $PACKAGES; do
  echo "\"$pkg\": $BUMP_TYPE" >> $CHANGESET_FILE
done

cat >> $CHANGESET_FILE << EOF
---

Hotfix: $BRANCH
EOF

echo -e "${WHITE}   ⎿ ✓ Changeset 생성: $(basename $CHANGESET_FILE)"
echo ""
cat $CHANGESET_FILE | sed 's/^/      /'
echo ""

# Changeset version 실행
echo -e "${WHITE}2️⃣ 버전 업데이트 실행 중...${RESET}"
if ! pnpm changeset version; then
  echo -e "   ⎿ ${RED}✗${RESET}${WHITE} Changeset version 실패${RESET}"
  rm -f $CHANGESET_FILE
  exit 1
fi
echo -e "${WHITE}   ⎿ ✓ 버전 업데이트 완료${RESET}"
echo ""

# 업데이트된 내용 표시
echo "   업데이트된 파일:"
git status --short | sed 's/^/   ⎿ /'
echo ""

# 커밋
echo -e "${WHITE}3️⃣ 변경사항 커밋 중...${RESET}"
git add .
git commit -m "chore(hotfix): version packages

Hotfix: $BRANCH
Auto-generated by git-flow pre-hotfix hook"

echo -e "${WHITE}   ⎿ ✓ 커밋 완료${RESET}"
echo ""

# Stash 복구
if [ "$STASHED" = true ]; then
  git stash pop
fi

echo -e "${WHITE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "${GREEN}✓${RESET}${WHITE} Hotfix Hook 완료${RESET} - git flow hotfix finish 계속 진행"
echo ""

exit 0
