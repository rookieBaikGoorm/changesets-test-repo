#!/bin/bash
#
# Git Flow Release Hook - Automatic Version Update
#
# This hook runs before 'git flow release finish'
# It automatically runs changeset version and commits the updates
#

set -e

BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# release ë¸Œëœì¹˜ì¸ì§€ í™•ì¸
if [[ ! $BRANCH =~ ^release/ ]]; then
  echo "âš ï¸  Release ë¸Œëœì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤: $BRANCH"
  exit 0
fi

echo ""
echo "ğŸš€ Git Flow Release Hook ì‹¤í–‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Changeset íŒŒì¼ í™•ì¸
CHANGESET_FILES=$(ls .changeset/*.md 2>/dev/null | grep -v README.md || echo "")

if [ -z "$CHANGESET_FILES" ]; then
  echo "âš ï¸  ê²½ê³ : Changeset íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
  echo ""
  echo "ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:"
  echo "  1. Changeset íŒŒì¼ ì¶”ê°€ í›„ ë‹¤ì‹œ ì‹œë„"
  echo "  2. ë²„ì „ ë³€ê²½ ì—†ì´ ê³„ì† ì§„í–‰"
  echo ""
  read -p "ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Release ì¤‘ë‹¨"
    exit 1
  fi
  echo ""
  echo "â„¹ï¸  ë²„ì „ ë³€ê²½ ì—†ì´ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤"
  exit 0
fi

echo "ğŸ“‹ ë°œê²¬ëœ Changeset íŒŒì¼:"
for file in $CHANGESET_FILES; do
  echo "  - $(basename $file)"
done
echo ""

# ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
if [ -n "$(git status --porcelain)" ]; then
  echo "âš ï¸  ê²½ê³ : ì»¤ë°‹ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤"
  git status --short
  echo ""
  read -p "ìŠ¤íƒœì‹œí•˜ê³  ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    git stash push -m "pre-release-hook-stash"
    STASHED=true
  else
    echo "âŒ Release ì¤‘ë‹¨"
    exit 1
  fi
fi

# Changeset version ì‹¤í–‰
echo "ğŸ”„ ë²„ì „ ì—…ë°ì´íŠ¸ ì‹¤í–‰ ì¤‘..."
if ! pnpm changeset version; then
  echo "âŒ Changeset version ì‹¤íŒ¨"
  exit 1
fi
echo "âœ… ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
echo ""

# ë¹Œë“œ ì‹¤í–‰ (ì„ íƒì )
echo "ğŸ”¨ íŒ¨í‚¤ì§€ ë¹Œë“œ ì¤‘..."
if ! pnpm build; then
  echo "âš ï¸  ë¹Œë“œ ì‹¤íŒ¨ - ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤"
else
  echo "âœ… ë¹Œë“œ ì™„ë£Œ"
fi
echo ""

# ë³€ê²½ì‚¬í•­ í™•ì¸
if [ -z "$(git status --porcelain)" ]; then
  echo "â„¹ï¸  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
  if [ "$STASHED" = true ]; then
    git stash pop
  fi
  exit 0
fi

# ì—…ë°ì´íŠ¸ëœ ë‚´ìš© í‘œì‹œ
echo "ğŸ“ ì—…ë°ì´íŠ¸ëœ íŒŒì¼:"
git status --short
echo ""

# ì»¤ë°‹
echo "ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
git add .
git commit -m "chore(release): version packages

ğŸ¤– Auto-generated by git-flow pre-release hook"

echo "âœ… ì»¤ë°‹ ì™„ë£Œ"
echo ""

# Stash ë³µêµ¬
if [ "$STASHED" = true ]; then
  git stash pop
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ Release Hook ì™„ë£Œ - git flow release finish ê³„ì† ì§„í–‰"
echo ""

exit 0





