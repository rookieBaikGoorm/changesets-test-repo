#!/bin/bash
#
# Git Flow Release Hook - Automatic Version Update
#
# This hook runs before 'git flow release finish'
# It automatically runs changeset version and commits the updates
#

set -e

BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# release ë¸Œëœì¹˜ì¸ì§€ í™•ì¸
if [[ ! $BRANCH =~ ^release/ ]]; then
  echo "âš ï¸  Release ë¸Œëœì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤: $BRANCH"
  exit 0
fi

echo ""
echo "ğŸš€ Git Flow Release Hook ì‹¤í–‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Changeset íŒŒì¼ í™•ì¸
CHANGESET_FILES=$(ls .changeset/*.md 2>/dev/null | grep -v README.md || echo "")

if [ -z "$CHANGESET_FILES" ]; then
  echo "âš ï¸  ê²½ê³ : Changeset íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
  echo ""
  echo "ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:"
  echo "  1) Changeset ìë™ ìƒì„± (Git Commit ê¸°ë°˜)"
  echo "  2) ë²„ì „ ë³€ê²½ ì—†ì´ ê³„ì† ì§„í–‰"
  echo "  3) Release ì·¨ì†Œ"
  echo ""
  read -p "ì„ íƒ (1-3): " -n 1 -r
  echo ""

  case $REPLY in
    1)
      echo ""
      echo "ğŸ¤– Git Commit ë¶„ì„ ë° Changeset ìë™ ìƒì„± ì¤‘..."
      echo ""

      # ë² ì´ìŠ¤ ë¸Œëœì¹˜ ì°¾ê¸° (develop ë˜ëŠ” main)
      BASE_BRANCH=""
      if git rev-parse --verify develop >/dev/null 2>&1; then
        BASE_BRANCH="develop"
      elif git rev-parse --verify main >/dev/null 2>&1; then
        BASE_BRANCH="main"
      else
        echo "âŒ ë² ì´ìŠ¤ ë¸Œëœì¹˜(develop ë˜ëŠ” main)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        exit 1
      fi

      echo "ğŸ“ ë² ì´ìŠ¤ ë¸Œëœì¹˜: $BASE_BRANCH"
      echo ""

      # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„± (ë°ì´í„° ì €ì¥ìš©)
      TMP_DIR=$(mktemp -d)
      trap "rm -rf $TMP_DIR" EXIT

      # packages ë° apps ë””ë ‰í† ë¦¬ì˜ íŒ¨í‚¤ì§€ ì •ë³´ ìˆ˜ì§‘
      echo "" > "$TMP_DIR/packages.txt"
      for pkg_dir in packages/*/ apps/*/; do
        if [ -f "${pkg_dir}package.json" ]; then
          pkg_name=$(cat "${pkg_dir}package.json" | grep '"name"' | head -1 | sed 's/.*"name": "\(.*\)".*/\1/')
          pkg_path="${pkg_dir%/}"
          echo "$pkg_path|$pkg_name" >> "$TMP_DIR/packages.txt"
        fi
      done

      # ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      commits=$(git log $BASE_BRANCH..HEAD --format=%H --reverse)

      if [ -z "$commits" ]; then
        echo "âš ï¸  ìƒˆë¡œìš´ ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤"
        echo "âŒ Release ì¤‘ë‹¨"
        exit 1
      fi

      echo "ğŸ“Š ë¶„ì„ ì¤‘ì¸ ì»¤ë°‹:"
      for commit in $commits; do
        msg=$(git log -1 --format=%s $commit)
        echo "  â€¢ $msg"

        # Conventional Commits íŒŒì‹±
        bump_type="patch"
        description=""

        # BREAKING CHANGE ë˜ëŠ” ! ì²´í¬ (major)
        if echo "$msg" | grep -qE '!:|BREAKING CHANGE'; then
          bump_type="major"
          description=$(echo "$msg" | sed -E 's/^[a-z]+(\([^)]+\))?!?: //')
        # feat: ì²´í¬ (minor)
        elif echo "$msg" | grep -qE '^feat(\([^)]+\))?: '; then
          bump_type="minor"
          description=$(echo "$msg" | sed -E 's/^feat(\([^)]+\))?: //')
        # fix: ì²´í¬ (patch)
        elif echo "$msg" | grep -qE '^fix(\([^)]+\))?: '; then
          bump_type="patch"
          description=$(echo "$msg" | sed -E 's/^fix(\([^)]+\))?: //')
        # ê¸°íƒ€ (ë¬´ì‹œí•˜ê±°ë‚˜ patch)
        elif echo "$msg" | grep -qE '^(chore|docs|style|refactor|test|perf|ci|build)(\([^)]+\))?: '; then
          continue  # ì´ëŸ° ì»¤ë°‹ì€ changesetì— í¬í•¨í•˜ì§€ ì•ŠìŒ
        else
          # ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠëŠ” ì»¤ë°‹ì€ patchë¡œ ì²˜ë¦¬
          description="$msg"
        fi

        # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
        changed_files=$(git diff-tree --no-commit-id --name-only -r $commit)

        # ê° íŒ¨í‚¤ì§€ë³„ë¡œ ë¶„ë¥˜
        while IFS='|' read -r pkg_path pkg_name; do
          if [ -z "$pkg_path" ]; then continue; fi

          if echo "$changed_files" | grep -q "^$pkg_path/"; then
            # íŒ¨í‚¤ì§€ë³„ ë°ì´í„° íŒŒì¼
            pkg_data_file="$TMP_DIR/$(echo "$pkg_name" | sed 's/[@\/]/_/g').txt"

            # description ì¶”ê°€
            echo "- $description" >> "$pkg_data_file"

            # bump type ì—…ë°ì´íŠ¸ (major > minor > patch)
            bump_file="$TMP_DIR/$(echo "$pkg_name" | sed 's/[@\/]/_/g').bump"
            current_bump=""
            if [ -f "$bump_file" ]; then
              current_bump=$(cat "$bump_file")
            fi

            new_bump="$current_bump"
            if [ "$bump_type" = "major" ]; then
              new_bump="major"
            elif [ "$bump_type" = "minor" ] && [ "$current_bump" != "major" ]; then
              new_bump="minor"
            elif [ -z "$current_bump" ]; then
              new_bump="$bump_type"
            fi

            if [ "$new_bump" != "$current_bump" ]; then
              echo "$new_bump" > "$bump_file"
            fi
          fi
        done < "$TMP_DIR/packages.txt"
      done

      echo ""

      # Changeset íŒŒì¼ ìƒì„±
      package_count=$(find "$TMP_DIR" -name "*.bump" 2>/dev/null | wc -l)
      if [ "$package_count" -eq 0 ]; then
        echo "âš ï¸  ë³€ê²½ëœ íŒ¨í‚¤ì§€ê°€ ì—†ìŠµë‹ˆë‹¤"
        echo ""
        echo "â„¹ï¸  ë²„ì „ ë³€ê²½ ì—†ì´ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤"
        exit 0
      fi

      echo "ğŸ“ ìƒì„±ëœ Changeset:"
      echo ""

      changeset_id="auto-$(date +%s)"
      changeset_file=".changeset/${changeset_id}.md"

      # Changeset íŒŒì¼ ì‘ì„±
      {
        echo "---"
        # frontmatter ì‘ì„±
        while IFS='|' read -r pkg_path pkg_name; do
          if [ -z "$pkg_path" ]; then continue; fi

          bump_file="$TMP_DIR/$(echo "$pkg_name" | sed 's/[@\/]/_/g').bump"
          if [ -f "$bump_file" ]; then
            bump_type=$(cat "$bump_file")
            echo "\"$pkg_name\": $bump_type"
          fi
        done < "$TMP_DIR/packages.txt"

        echo "---"
        echo ""

        # ë³€ê²½ ë‚´ìš© ì‘ì„±
        while IFS='|' read -r pkg_path pkg_name; do
          if [ -z "$pkg_path" ]; then continue; fi

          pkg_data_file="$TMP_DIR/$(echo "$pkg_name" | sed 's/[@\/]/_/g').txt"
          if [ -f "$pkg_data_file" ]; then
            cat "$pkg_data_file"
            echo ""
          fi
        done < "$TMP_DIR/packages.txt"
      } > "$changeset_file"

      # ìƒì„±ëœ ë‚´ìš© í‘œì‹œ
      cat "$changeset_file"
      echo ""

      echo "âœ… Changeset íŒŒì¼ì´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: $changeset_file"
      echo ""

      # ë‹¤ì‹œ changeset íŒŒì¼ í™•ì¸
      CHANGESET_FILES=$(ls .changeset/*.md 2>/dev/null | grep -v README.md || echo "")
      ;;
    2)
      echo ""
      echo "â„¹ï¸  ë²„ì „ ë³€ê²½ ì—†ì´ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤"
      exit 0
      ;;
    3|*)
      echo "âŒ Release ì¤‘ë‹¨"
      exit 1
      ;;
  esac
fi

echo "ğŸ“‹ ë°œê²¬ëœ Changeset íŒŒì¼:"
for file in $CHANGESET_FILES; do
  echo "  - $(basename $file)"
done
echo ""

# ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸ (.changeset íŒŒì¼ ì œì™¸)
CHANGES=$(git status --porcelain | grep -v "^.. .changeset/" || true)
if [ -n "$CHANGES" ]; then
  echo "âš ï¸  ê²½ê³ : ì»¤ë°‹ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤"
  echo "$CHANGES"
  echo ""
  read -p "ìŠ¤íƒœì‹œí•˜ê³  ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    git stash push -m "pre-release-hook-stash"
    STASHED=true
  else
    echo "âŒ Release ì¤‘ë‹¨"
    exit 1
  fi
fi

# Changeset version ì‹¤í–‰
echo "ğŸ”„ ë²„ì „ ì—…ë°ì´íŠ¸ ì‹¤í–‰ ì¤‘..."
if ! pnpm changeset version; then
  echo "âŒ Changeset version ì‹¤íŒ¨"
  exit 1
fi
echo "âœ… ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
echo ""

# ë³€ê²½ì‚¬í•­ í™•ì¸
if [ -z "$(git status --porcelain)" ]; then
  echo "â„¹ï¸  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
  if [ "$STASHED" = true ]; then
    git stash pop
  fi
  exit 0
fi

# ì—…ë°ì´íŠ¸ëœ ë‚´ìš© í‘œì‹œ
echo "ğŸ“ ì—…ë°ì´íŠ¸ëœ íŒŒì¼:"
git status --short
echo ""

# ì»¤ë°‹
echo "ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
git add .
git commit -m "chore(release): version packages

ğŸ¤– Auto-generated by git-flow pre-release hook"

echo "âœ… ì»¤ë°‹ ì™„ë£Œ"
echo ""

# Stash ë³µêµ¬
if [ "$STASHED" = true ]; then
  git stash pop
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ Release Hook ì™„ë£Œ - git flow release finish ê³„ì† ì§„í–‰"
echo ""

exit 0





